# VINS初始化

## 一、VIO相关知识回顾

### 1、IMU预积分

#### **i. IMU传感器模型：**

$$
\boldsymbol{w^b_{meas}=w^b_{gt}+b^g+n^g}\\
\boldsymbol{a^b_{meas}=R_{bw}(a^w_{gt}+g^w)+b^a+n^a}
$$

其中，下标gt表示真实值，meas表示测量值；上标b表示bodyframe，w表示worldframe；上标g表示陀螺仪相关，a表示加速度计相关。

#### ii. IMU预积分推导(手写)

![]()

#### iii. IMU预积分结果

![](..\img\37.png)

## 视觉几何基础

## 二、鲁棒初始化

参考：https://blog.csdn.net/jdy_lyy/article/details/119258236

*注：详细过程论文中有写。*

介绍之前，先考虑几个问题：

1. IMU怎么和世界坐标系对齐，如何计算初始时刻的qwb0？
2. 单目视觉姿态如何与IMU轨迹对齐，尺度如何获取？
3. VIO系统的初始化速度v，传感器bias等如何估计？
4. IMU和相机之间的外参数如何估计？
5. 重力加速度如何估计？

### 1、利用旋转约束估计外参qbc

​	qbc就是IMU与相机之间的相对位置。一般来讲，二者安装起来，平移距离比较小，但可能包括旋转信息。且旋转为非线性(最简单的旋转sin,cos)，平移一般为线性，因此旋转需要估计。平移距离一般手动测量一般即可。

​	相邻两时刻k,k+1之间有：IMU旋转积分qbkbk+!，视觉测量qckck+1，理论上应该有：
$$
q_{b_kb_{k+1}}⊗q_{bc}=q_{bc}⊗q_{c_kc_{k+1}}
$$
上式就是两种从 bk转换到ck+1的旋转方式。

​	由于误差等因素，上式不严格相等，我们进行处理：
$$
([q_{b_kb_{k+1}}]_L-[q_{c_kc_{k+1}}]_R)=Q_{k+1}^kq_{bc}=0
$$
我们求解非线性优化问题即可：

![](..\img\38.png)

### 2、估计陀螺仪的bias

![](..\img\39.png)

思路与估计qbc类似。

### 3、初始化速度、重力和尺度因子

​	需要估计的变量：

![](..\img\40.png)

其中，v^bk_k表示k时刻body坐标系的速度在body坐标系下的表示。gc0为重力向量在第0帧相机坐标系下的表示。s表示尺度因子，将视觉轨迹拉伸到米制单位。

**回顾预积分**
$$
\alpha_{b_ib_j}=q_{b_iw}(p_{wb_j}-p_{wb_i}-v_i^w\Delta t
+\frac{1}{2}g^w\Delta t^2)\\
\beta_{b_ib_j}=q_{b_iw}(v_j^w-v_i^w+g^w\Delta t)
$$
我们需要估计的变量是参照body坐标系和相机坐标系的，因此，我们把预积分中有关世界坐标系的均转化为相机初始时刻坐标系c0，有：

![](..\img\41.png)

我们给出估计qbc所需的公式：
$$
q_{c_0b_k}=q_{c_0c_k}⊗q^{-1}_{bc}\\
s\bar{p}_{c_0b_k}=s\bar{p}_{c_0c_k}-R_{c_0b_k}p_{bc}
$$
联立(14)和上式，得到：

![](..\img\42.png)

将待估计变量放到方程右边，有：

![](..\img\43.png)

其中，第一行是α预积分量得到的公式；第二行为β预积分量得到的公式。H矩阵为：

![](..\img\44.png)

这样，我们就可以把公式(16)转换为线性最小二乘问题对状态量进行求解：

![](..\img\45.png)

### 4、优化重力向量gc0

​	在3中的估计gc0时，我们没有考虑g的模长为固定的，即
$$
||g^{c_0}||=9.81
$$
三维向量gc0实际只有两个自由度。

我们对其进行参数化，过程如下图：

![](..\img\46.png)

其中，
$$
\bar{g^{c_0}}为初始值方向的单位向量\\
b_1和b_2均为单位方向向量\\
w_1,w_2为待优化参数
$$
我们将这个参数化的重力向量代入3中所述优化公式即可：

![](..\img\47.png)

### 5、将相机坐标系对齐世界坐标系

**对齐过程：**

1. 找到c0到w系的旋转矩阵Rwc0，利用李代数
   $$
   R_{wc_0}=e^{w^{\check{ }}\theta}\\
   w=\frac{\hat{g}^{c_0}×\hat{g}^w}{||\hat{g}^{c_0}×\hat{g}^w||}\\
   \theta=atan2(||\hat{g}^{c_0}×\hat{g}^w||,\hat{g}^{c_0}·\hat{g}^w)
   $$
   旋转轴为w，旋转角度为θ

2. 把所有c0坐标系下的变量旋转到w下

3. 相机平移和特征点尺度恢复到米制单位

至此，完成了系统初始化过程。

















