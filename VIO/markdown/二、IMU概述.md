# IMU概述

## 二、IMU测量模型以及运动模型

### 1、MEMS加速度计工作原理

​	测量原理可以用一个简单的质量块+弹簧+指示计来表示。

​	加速度计测量值am为弹簧拉力对应的加速度。
$$
a_m=\frac{f}{m}=a-g
$$
其中，f为弹簧拉力，a为物体在惯性系下的加速度，g为重力加速度。

**我们举个例子，并且介绍一下东北天坐标系(ENU)**

![](..\img\1.png)

### 2、陀螺仪测量原理

## 三、IMU误差模型

**误差分类：**

1. 加速度计和陀螺仪的误差可以分为：确定性误差、随机误差
2. 确定性误差可以事先标定确定，包括：bias(偏差)，scale(尺度)等等
3. 随机误差通常假设噪声服从高斯分布，包括：高斯白噪声，bias随机游走

### 1、确定性误差

#### Bias

​	理论上，当没有外部作用时，IMU传感器的输出应该为0。但是，实际数据存在一个偏置bias。加速度计bias对位姿估计的影响：(注意这里是偏置对速度以及位置的影响)
$$
v_{err}=b_at \\ p_{err} = \frac{1}{2}b_at^2
$$

#### Scale

​	scale可以看成是实际数值和传感器输出值之间的比值。

![](..\img\2.png)

### 2、误差模型

​	多轴IMU传感器制作时，由于制作工艺问题，可能会使得xyz轴不垂直，如下所示。

![](..\img\3.png)

公式可以理解为：测量值为尺度乘该轴上真实加速度加上另外两轴对该轴加速度的影响
$$
测量值=s_{xx}a_x+m_{xy}a_y+m_{xz}a_z
$$


### 3、六面法标定加速度

​	https://www.cnblogs.com/buxiaoyi/p/7541974.html

### 4、IMU随机误差

​	IMU数据在连续时间上受到一个均值为0，方差为σ，各时刻之间相互独立的高斯过程n(t)
$$
E[n(t)]=0\\
E[n(t_1)n(t_2)]=\sigma^2\delta(t_1-t_2)
$$
其中，δ()为狄拉克函数。

## 四、IMU数学模型

### 1、加速度计数学模型

​	假设在东北天(ENU)坐标系下，gG=(0,0,-9.81)^T，理论测量值则为：
$$
a^B_m=R_{BG}(a^G-g^G)
$$
*下标m代表测量值，上标B代表Body参考系*

若考虑高斯白噪声、偏置bias、尺度因子，则测量值为：
$$
a_m^B=S_aR_{BG}(a^G-g^G)+n_a+b_a
$$
*通常假设尺度因子为单位矩阵*

### 2、陀螺仪数学模型

​	考虑尺度因子、高斯白噪声以及bias，陀螺仪的误差模型如下：
$$
w_m^B=S_gw^B+n_g+b_g
$$
​	陀螺仪受到的四种噪声的影响分别如下图所示：

![](..\img\4.png)

## 五、运动模型离散时间处理

### 1、连续情况

​	**在实际VIO中，我们通常忽略scale影响，只考虑白噪声和bias随机游走**

![](..\img\5.png)

​	PVQ对时间的导数可以写成：(Pose,Velocity,Quaternion)
$$
\dot p_{wb_t}=v^w_t\\
\dot v_t^w = a_t^w\\
\dot q_{wb_t} = q_{wb_t}⊗
\begin{bmatrix}
0\\ \frac{1}{2} w^{b_t}
\end{bmatrix}
$$
我们对上式进行积分，得到：

**逐一推导：**

​	首先，四元数导数积分
$$
q_{wb_j}=\int_{t\in [i,j]}\dot q_{wb_t}dt=\int_{t\in [i,j]}q_{wb_t}⊗
\begin{bmatrix}
0\\ \frac{1}{2} w^{b_t}
\end{bmatrix}dt
$$
​	其次，对加速度进行积分
$$
\int_{t\in[i,j]} \dot v_t^wdt=v_j^w-v_i^w\\
=\int_{t\in[i,j]} [q_{wb_t}(a_m^{bt}-n_a-b_a)+g^w]dt
$$
​	最后，对加速度进行两次积分
$$
\int_{t\in[i,j]} \dot p^w_tdt=p^{w}_{bj}-p^w_{bi}\\
\int \int_{t\in[i,j]} [q_{wb_t}(a_m^{bt}-n_a-b_a)+g^w]dt^2=\int_{t\in[i,j]} (v_t^w-v_i^w)dt\\
=p_{b_j}^w-p_{b_i}^w-v_i^wΔt
$$
推导完毕。

### 2、离散情况

![](..\img\6.png)

## 六、IMU预积分

### 1、概述及推导

​	**由上一节可知，每次优化qwbt后，其值改变，都需要重新进行积分，运算量较大。**

因此，利用转换公式获得预积分模型：
$$
q_{wb_t}=q_{wb_i}⊗q_{b_ib_t}
$$
那么，PVQ积分公式中的积分项则变为相对于第i时刻的姿态，而不是相对于世界坐标系的姿态：

![](..\img\7.png)

**推导：？？？？？？？？？？？？？**

### 2、预积分量

#### 连续形式

​	预积分量**仅仅与IMU的测量值有关**，它将一段时间内的IMU数据直接积分起来就得到了预积分量。

*VINS论文中有这个量*

![](..\img\9.png)

#### 离散形式

![](..\img\10.png)

### 3、预积分的误差

​	**定义：一段时间内IMU构建的预积分量作为测量值，对两时刻之间的状态量进行约束：**

![](..\img\8.png)

其中，位移、速度、偏置误差都是直接相减得到，而第二项式关于四元数的旋转误差，其中[]xyz表示只取四元数虚部(x,y,z)组成的三维向量。

### 4、预积分量的方差

​	*疑问：一个IMU数据作为测量值的噪声方差我们能够标定。现在，一段时间内多个IMU数据积分形成的预积分量的方差如何计算？*

##### Covariance Propagation 协方差传递

$$
已知一个变量:y=Ax,x\in N(0,Σ_x)，则有Σ_y = AΣ_xA^T\\
Σ_y=E(yy^T)=E(Axx^T A^T)=AE(xx^T)A^T=AΣ_xA^T
$$

**因此，要推导预积分量的协方差，我们需要知道imu噪声和预积分量之间的线性递推关系。**

​	根据上述推导，我们假设已知相邻时刻误差的线性传递方程：
$$
η_{ik}=F_{k-1}η_{ik-1}+G_{k-1}n_{k-1}
$$
​	误差的传递由**两部分组成**：当前时刻的误差传递给下一时刻、当前时刻测量噪声传递给下一时刻。
$$
Σ_{ik}=F_{k-1}Σ_{ik-1}F^T_{k-1}+G_{k-1}Σ_nG_{k-1}^T
$$
其中，Σn是测量噪声的协方差矩阵，方差从i时刻开始进行递推，Σii=0。

### 5、状态误差线性递推公式推导

​	由于我们要推导预积分量的方差，因此我们需要求出状态误差递推的线性关系。

​	通常对于状态量之间的递推关系是非线性的方程：
$$
x_k=f(x_{k-1},u_{k-1})
$$
其中状态量为x，系统输入量为u。

#### i. 基于一阶泰勒展开的误差递推方程

​	令状态量为
$$
x=\hat x + \delta x
$$
其中，真值为xhat，误差为δx。输入量u的噪声为n。

​	下面展示基于泰勒展开的误差传递(应用于EKF的协方差预测)
$$
非线性系统x_k=f(x_{k-1},u_{k-1})的状态误差的线性递推关系如下：
\\
\delta x_k = F\delta x_{k-1}+Gn_{k-1}\\
$$
其中，F是状态量xk对状态量x{k-1}的雅可比矩阵，G是状态量xk对输入量
u{k-1}的雅可比矩阵。

​	推导：（假设误差量为小量）
$$
x_k=f(x_{k-1},u_{k-1})\\
\hat x_k+\delta x_k = f(\hat x_{k-1}+\delta x_{k-1}
,\hat u_{k-1}+n_{k-1})\\
=f(\hat x_{k-1},\hat u_{k-1})+F\delta x_{k-1}+G n_{k-1}
$$

#### ii. 基于误差随时间变化的递推方程

​	若我们能够推导状态误差随时间变化的导数关系，例如：
$$
\dot{\delta x}=A\delta x+Bn
$$
则误差状态的传递方程为：
$$
\delta x_k= \delta x_{k-1}+\dot{\delta x_{k-1}}Δt\\
\delta x_k=(I+AΔt)\delta x_{k-1}+BΔtn_{k-1}
$$
对比两种方法，得到：
$$
F=I+AΔt\\
G=BΔt
$$

#### iii. 基于第一种方式推导预积分方差

​	后弦，回顾预积分的误差递推公式，将测量噪声也考虑进模型

![](..\img\11.png)

用前面一阶泰勒展开的推导方式，我们希望能推导出如下形式：

![](..\img\12.png)

这里我们直接给出F，G的最终形式

![](..\img\13.png)

其中，系数为

![](..\img\14.png)

#### iv. 推导

### 七、优化问题中残差的构建以及雅可比矩阵的求解

#### i. 视觉重投影残差

​	对于第i帧中的特征点，投影到第j帧相机坐标系下的值为：
$$
x_j=T_{ji}x_i=T_{jw}T_{wi}x_i
$$
其中，Tji为两相邻帧间的相对位姿。这只是简易表示方法。**在VIO中，我们要考虑相机与imu之间的外参。**因此，我们重新构建上述表达式：
$$
\begin{bmatrix}
x_{c_j}\\y_{c_j}\\z_{c_j}\\1
\end{bmatrix}=T_{cb}T_{b_jw}T_{wb_i}T_{bc}
\begin{bmatrix}
x_{c_i}\\y_{c_i}\\z_{c_i}\\1
\end{bmatrix}
$$
再把相机内参加入公式：
$$
\begin{bmatrix}
u\\v\\1
\end{bmatrix}=
{\lambda}K\begin{bmatrix}
x_{c_i}\\y_{c_i}\\z_{c_i}
\end{bmatrix}
$$

#### ii. IMU预积分残差













